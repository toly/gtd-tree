"use strict";angular.module("gtdTreeApp",["ngCookies","ngResource","ngSanitize","ngRoute","LocalStorageModule"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","localStorageService","Projects",function(a,b,c){a.projects=c.projects,a.current_project={}}]),angular.module("gtdTreeApp").directive("customAutofocus",function(){return{restrict:"A",link:function(a,b,c){a.$watch(function(){return a.$eval(c.customAutofocus)},function(a){1==a&&b[0].focus()})}}}),angular.module("gtdTreeApp").factory("Projects",["$rootScope","localStorageService",function(a,b){function c(a){a.id=this.get_last_project_id()+1,this.projects.push(a),this.save()}function d(){var a=0;for(var b in this.projects){var c=this.projects[b];c.id>a&&(a=c.id)}return a}function e(){b.add(j,this.projects),a[j]=this.projects}function f(a){this.projects=this.projects.filter(function(b){return b.id!=a}),this.save()}function g(a){for(var b in this.projects)if(this.projects[b].id==a)return this.projects[b]}function h(){for(var a=b.get(j)||[],c=0;c<a.length;c++)a[c].edit=!1;return a}function i(a,b){for(var c=0;c<this.projects.length;c++)this.projects[c].id==a&&(this.projects[c].title=b);this.save()}var j="projects";return{projects:h(),get_last_project_id:d,create:c,remove:f,save:e,get_project:g,update_project_title:i}}]),angular.module("gtdTreeApp").factory("Trees",["$rootScope","localStorageService",function(a,b){function c(a){return this.trees[a]||[{name:"Node",nodes:[],root:!0}]}function d(a){for(var b=["id","name","done","parent"],c=$.map(a,function(a){return $.extend({},a)}),d=0;d<c.length;d++)for(var e in c[d])b.indexOf(e)<0&&delete c[d][e];return c}function e(a,c){this.trees[a]=d(c),b.add(g,this.trees)}function f(a){delete this.trees[a],b.add(g,this.trees)}var g="trees";return{trees:b.get(g)||{},get_project_tree:c,save_project_tree:e,remove_project_tree:f}}]),angular.module("gtdTreeApp").controller("MainCtrl",["$scope",function(){}]),angular.module("gtdTreeApp").controller("ProjectsCtrl",["$scope","$rootScope","Projects","Trees",function(a,b,c,d){a.new_project={},a.add_project=function(){c.create(a.new_project),a.new_project={},a.new_project_show=!1},a.remove_project=function(a){var e=c.get_project(a),f=confirm('Are you sure you want to delete a project "'+e.title+'"?');f&&(b.current_project&&b.current_project.id==a&&(b.current_project={}),c.remove(a),d.remove_project_tree(a))},a.select_project=function(a){for(var d=0;d<c.projects.length;d++)if(c.projects[d].edit)return;b.current_project=c.get_project(a)},a.blur_edit_input=function(a){a.edit=!1,c.update_project_title(a.id,a.title)},a.input_keypress=function(a,b){13==a.keyCode&&(b.edit=!1,c.update_project_title(b.id,b.title))}}]),angular.module("gtdTreeApp").controller("TreeCtrl",["$scope","$rootScope","Trees",function(a,b,c){function d(){function b(c,d,e){var f=a.get_childs(c);for(var g in f){var h=f[g],i=e.slice(0);i.push(parseInt(g)+1);var j=i.join(".");1==j.length&&(j+="."),a.indexes[h.id]=j,b(h.id,d+1,i)}}a.indexes={},b(null,0,[])}a.nodes=[],a.focus_id=null,a.indexes={},a.cut_node_id=null,a.show_done_tasks=!0,a.set_all_expand=function(b){for(var c=0;c<a.nodes.length;c++)null!=a.nodes[c].id&&(a.nodes[c].hide_childs=b)},a.remove_done_tasks=function(){a.nodes=a.nodes.filter(function(a){return 1!=a.done}),a.save_project()},a.set_cut_node_id=function(b){a.cut_node_id=a.cut_node_id==b?null:b},a.set_parent_node=function(b){for(var c=0;c<a.nodes.length;c++)if(a.nodes[c].id==a.cut_node_id)return a.nodes[c].parent=b,a.cut_node_id=null,void a.save_project()},a.get_new_id=function(){for(var b=0,c=0;c<a.nodes.length;c++)a.nodes[c].id>b&&(b=a.nodes[c].id);return b+1},a.get_childs=function(b){return a.nodes.filter(function(a){return a.parent===b})},a.add_child=function(b){var c=a.get_new_id();a.nodes.push({id:c,parent:b,name:"",edit:!0}),a.focus_id=c},a.delete_childs=function(b){for(var c,d=[],e=[b];e.length>0;){c=e.shift();var f=a.get_childs(c);for(var g in f){var h=f[g].id;e.push(h),d.push(h)}}a.nodes=a.nodes.filter(function(a){return-1==d.indexOf(a.id)}),a.save_project()},a.delete_node=function(b){a.delete_childs(b),a.nodes=a.nodes.filter(function(a){return a.id!=b}),a.save_project()},a.done_nodes=function(){return a.nodes.filter(function(a){return a.done})},a.get_progress=function(){return{total:a.nodes.length,done:a.done_nodes().length}},a.key_press_node_input=function(b,c){13==b.keyCode&&(c.edit=!1,a.focus_id=null,a.save_project())},b.$watch("current_project",function(){a.nodes=c.get_project_tree(b.current_project.id)}),a.save_project=function(){c.save_project_tree(b.current_project.id,a.nodes)},a.node_input_unfocus=function(b){b.edit=!1,a.focus_id=null,a.save_project()},a.node_edit=function(b){b.edit=!0,a.focus_id=b.id},a.make_pdf=function(){a.is_pdf_rendering=!0,d();for(var b=new jsPDF("p","pt","a4"),c=0;c<a.nodes.length;c++)a.nodes[c].hover&&(a.nodes[c].hover=!1);b.addHTML(document.getElementById("project"),10,10,function(){b.output("dataurlnewwindow",{}),a.is_pdf_rendering=!1})}}]);